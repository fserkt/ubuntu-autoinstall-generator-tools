#!/bin/bash

#This script will be executed *after* all the other init scripts.
#You can put your own initialization stuff in here if you don't
#want to do the full Sys V style init stuff.


file="/etc/rc.local"

# the following functions are used for logging purposes and are not recommended to be modified
# set extraiable value
DATE=`date "+%Y-%m-%d %H:%M:%S"`
USER=`whoami`
HOST_NAME=`hostname`
LOG_FILE="/var/log/rc-local.log"

# Execution successful log printing path
function log_info () {
    echo "${DATE} ${HOST_NAME} ${USER} execute $0 [INFO] $@" >> ${LOG_FILE}
}

# Execution successful ‚ö†Ô∏è warning log print path
function log_warn () {
    echo "${DATE} ${HOST_NAME} ${USER} execute $0 [WARN] $@" >> ${LOG_FILE}
}

# Execution failure log print path
function log_error () {
    echo -e "\033[41;37m ${DATE} ${HOST_NAME} ${USER} execute $0 [ERROR] $@ \033[0m"  >> ${LOG_FILE}
}

function fn_log ()  {
    if [  $? -eq 0  ]
    then
            log_info "üëç $@ sucessed."
            echo -e "\033[32m $@ sucessed. \033[0m"
    else
            log_error "üëø $@ failed."
            echo -e "\033[41;37m $@ failed. \033[0m"
            exit 1
    fi
}

# this is an example of password mysql change
IMG="ECV-8.3.3.5_86013.qcow2"
while true; do
    process_num=`ps -ef | grep libvirtd  | grep -v grep | wc -l`
    if [ $process_num -ne 0 ]; then
        log_info "waiting for 2s"
        sleep 2
        virsh list | grep "running" | awk '{print $3}'
        if [  $? -eq 0 ]; then
           log_info  "sliver-peak is running"
           rm -rf /root/sliver-peak.xml
        else
           log_info  "Deploy a VM and enable automatic startup for the VM"
           virsh define /root/sliver-peak.xml
           virsh start sliver-peak
           virsh autostart sliver-peak
           virsh list | grep "running" | awk '{print $3}'
           if [ $? -eq 0 ]; then
               log_info  "sliver-peak is running"
               rm -rf /root/sliver-peak.xml
           fi
        fi
    else
        sleep 2
        log_info "waiting for 2s"
    fi
done
fn_log "Clean files ${file}"
rm  -f ${file}
exit 0